name: Update profile views badge

on:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours
  workflow_dispatch:       # allow manual run
  push:
    branches: ["main"]     # optional: run on push to main

permissions:
  contents: write

jobs:
  update-profile-views:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch traffic data from GitHub API and generate badge
        env:
          GH_TOKEN: ${{ secrets.GH_TRAFFIC_TOKEN }}
          OWNER: "ARPANPATRA111"
          REPO: "ARPANPATRA111"
        run: |
          mkdir -p data assets

          # Get traffic data (last 14 days)
          traffic_json=$(curl -s \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/traffic/views")

          echo "$traffic_json" > data/traffic-latest.json

          # Extract 14-day count (total views over last 14 days)
          current_count=$(echo "$traffic_json" | jq '.count')

          # Read previous data if exists
          if [ -f data/profile-views.json ]; then
            last_count=$(jq '.last_14_days_count' data/profile-views.json)
            total=$(jq '.total' data/profile-views.json)
          else
            last_count=0
            total=0
          fi

          # Delta for this period
          delta=$(( current_count - last_count ))
          if [ "$delta" -lt 0 ]; then
            delta=0
          fi

          new_total=$(( total + delta ))

          # Save updated json
          cat > data/profile-views.json <<EOF
          {
            "last_14_days_count": ${current_count},
            "total": ${new_total}
          }
          EOF

          echo "Current 14-day count: ${current_count}"
          echo "Previous 14-day count: ${last_count}"
          echo "New total: ${new_total}"

          # ----- Shield-style SVG badge -----
          label_text="PROFILE VIEWS"
          value_text="${new_total}"

          # Fixed label width, dynamic value width based on digits
          label_width=110
          value_width=$(( 20 + 8 * ${#value_text} ))
          total_width=$(( label_width + value_width ))

          label_x=$(( label_width / 2 ))
          value_x=$(( label_width + value_width / 2 ))

          cat > assets/profile-views.svg <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="${total_width}" height="20" role="img" aria-label="PROFILE VIEWS ${value_text}">
            <mask id="m">
              <rect width="${total_width}" height="20" rx="3" fill="#fff"/>
            </mask>

            <g mask="url(#m)">
              <rect width="${label_width}" height="20" fill="#555555"/>
              <rect x="${label_width}" width="${value_width}" height="20" fill="#3b82f6"/>
            </g>

            <g fill="#ffffff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="10">
              <text x="${label_x}" y="14">${label_text}</text>
              <text x="${value_x}" y="14">${value_text}</text>
            </g>
          </svg>
          EOF

      - name: Commit and push if changed
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/profile-views.json data/traffic-latest.json assets/profile-views.svg
            git commit -m "Update profile views badge"
            git push
          else
            echo "No changes to commit."
          fi
