name: ðŸ“Š Update Profile Views & Stats Badges

on:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours
  workflow_dispatch:       # allow manual run
  push:
    branches: [main, wall-experiments]
    paths:
      - '.github/workflows/profile-views.yml'

permissions:
  contents: write

concurrency:
  group: profile-views-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-profile-views:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch data from GitHub API and generate badges
        env:
          GH_TOKEN: ${{ secrets.GH_TRAFFIC_TOKEN }}
          OWNER: "ARPANPATRA111"
          REPO: "ARPANPATRA111"
        run: |
          mkdir -p data assets

          # ---------- Helper: function to generate shield-style badges ----------
          create_badge () {
            label_text="$1"
            value_text="$2"
            output_file="$3"

            # Fixed label width, dynamic value width based on length of number
            label_width=110
            value_width=$(( 20 + 8 * ${#value_text} ))
            total_width=$(( label_width + value_width ))

            label_x=$(( label_width / 2 ))
            value_x=$(( label_width + value_width / 2 ))

            cat > "${output_file}" <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="${total_width}" height="20" role="img" aria-label="${label_text} ${value_text}">
            <mask id="m">
              <rect width="${total_width}" height="20" rx="3" fill="#fff"/>
            </mask>

            <g mask="url(#m)">
              <rect width="${label_width}" height="20" fill="#555555"/>
              <rect x="${label_width}" width="${value_width}" height="20" fill="#3b82f6"/>
            </g>

            <g fill="#ffffff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="10">
              <text x="${label_x}" y="14">${label_text}</text>
              <text x="${value_x}" y="14">${value_text}</text>
            </g>
          </svg>
          EOF
          }

          # ---------- PROFILE VIEWS (repo traffic) ----------

          # Get traffic data (last 14 days)
          traffic_json=$(curl -s \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/traffic/views")

          echo "$traffic_json" > data/traffic-latest.json

          # Extract 14-day count
          current_count=$(echo "$traffic_json" | jq '.count')

          # Read previous data if exists
          if [ -f data/profile-views.json ]; then
            last_count=$(jq '.last_14_days_count' data/profile-views.json)
            total=$(jq '.total' data/profile-views.json)
          else
            last_count=0
            total=0
          fi

          # Delta for this period
          delta=$(( current_count - last_count ))
          if [ "$delta" -lt 0 ]; then
            delta=0
          fi

          new_total=$(( total + delta ))

          # Save updated json
          cat > data/profile-views.json <<EOF
          {
            "last_14_days_count": ${current_count},
            "total": ${new_total}
          }
          EOF

          echo "Current 14-day views: ${current_count}"
          echo "Previous 14-day views: ${last_count}"
          echo "New total profile views: ${new_total}"

          # Generate profile views badge
          create_badge "PROFILE VIEWS" "${new_total}" "assets/profile-views.svg"

          # ---------- FOLLOWERS ----------

          user_json=$(curl -s \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${OWNER}")

          followers=$(echo "$user_json" | jq '.followers')
          echo "Followers: ${followers}"

          create_badge "FOLLOWERS" "${followers}" "assets/github-followers.svg"

          # ---------- TOTAL STARS (all public repos) ----------

          total_stars=0
          page=1

          while : ; do
            repos=$(curl -s \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${OWNER}/repos?per_page=100&page=${page}")

            count=$(echo "$repos" | jq 'length')
            if [ "$count" -eq 0 ]; then
              break
            fi

            stars_page=$(echo "$repos" | jq '[.[].stargazers_count] | add // 0')
            total_stars=$(( total_stars + stars_page ))
            page=$(( page + 1 ))
          done

          echo "Total stars across repos: ${total_stars}"

          create_badge "STARS" "${total_stars}" "assets/github-stars.svg"

          # ---------- ISSUES CLOSED (across all repos) ----------

          # Search for closed issues authored by user
          issues_closed_json=$(curl -s \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/issues?q=author:${OWNER}+type:issue+is:closed")

          issues_closed=$(echo "$issues_closed_json" | jq '.total_count // 0')
          echo "Issues closed: ${issues_closed}"

          # Save to data file
          echo "{\"issues_closed\": ${issues_closed}}" > data/issues-stats.json

          # ---------- PULL REQUESTS MERGED (across all repos) ----------

          # Search for merged PRs authored by user
          prs_merged_json=$(curl -s \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/search/issues?q=author:${OWNER}+type:pr+is:merged")

          prs_merged=$(echo "$prs_merged_json" | jq '.total_count // 0')
          echo "PRs merged: ${prs_merged}"

          # Save to data file
          echo "{\"prs_merged\": ${prs_merged}}" > data/prs-stats.json

          # ---------- TOTAL COMMITS (using events API) ----------
          
          # Get user's push events from the last 90 days (approximate commit count)
          commits_count=0
          page=1
          
          while : ; do
            events=$(curl -s \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${OWNER}/events?per_page=100&page=${page}")
            
            count=$(echo "$events" | jq 'length')
            if [ "$count" -eq 0 ] || [ "$page" -gt 3 ]; then
              break
            fi
            
            # Count commits from PushEvents
            push_commits=$(echo "$events" | jq '[.[] | select(.type == "PushEvent") | .payload.commits | length] | add // 0')
            commits_count=$(( commits_count + push_commits ))
            page=$(( page + 1 ))
          done

          echo "Recent commits: ${commits_count}"

          # Save combined stats to JSON
          cat > data/github-activity-stats.json <<EOF
          {
            "issues_closed": ${issues_closed},
            "prs_merged": ${prs_merged},
            "recent_commits": ${commits_count},
            "updated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF

      - name: Update README with GitHub Activity Stats
        run: |
          # Read the stats from JSON
          issues_closed=$(jq '.issues_closed' data/github-activity-stats.json)
          prs_merged=$(jq '.prs_merged' data/github-activity-stats.json)
          commits_count=$(jq '.recent_commits' data/github-activity-stats.json)
          
          # Update Issues badge in README
          sed -i "s|!\[Issues Resolved\](https://img.shields.io/badge/ðŸ›_Issues_Resolved-[^-]*-2ecc71?style=for-the-badge&labelColor=1a1a2e)|![Issues Resolved](https://img.shields.io/badge/ðŸ›_Issues_Resolved-${issues_closed}-2ecc71?style=for-the-badge\&labelColor=1a1a2e)|g" README.md
          
          # Update PRs badge in README
          sed -i "s|!\[Pull Requests\](https://img.shields.io/badge/ðŸ”€_PRs_Merged-[^-]*-9b59b6?style=for-the-badge&labelColor=1a1a2e)|![Pull Requests](https://img.shields.io/badge/ðŸ”€_PRs_Merged-${prs_merged}-9b59b6?style=for-the-badge\&labelColor=1a1a2e)|g" README.md
          
          # Update Commits badge in README
          sed -i "s|!\[Commits\](https://img.shields.io/badge/ðŸ”¥_Commits-[^-]*-e74c3c?style=for-the-badge&labelColor=1a1a2e)|![Commits](https://img.shields.io/badge/ðŸ”¥_Commits-${commits_count}-e74c3c?style=for-the-badge\&labelColor=1a1a2e)|g" README.md
          
          echo "Updated README with: Issues=${issues_closed}, PRs=${prs_merged}, Commits=${commits_count}"

      - name: Commit and push if changed
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data/*.json assets/*.svg README.md
            git commit -m "ðŸ“Š Update profile stats badges [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
