name: ğŸ•’ Advanced WakaTime + Wake-Up Time Tracker

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'     # Daily at midnight UTC
    - cron: '0 */4 * * *'   # Every 4 hours
  workflow_dispatch:

jobs:
  wakatime-stats:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ï¿½ Install Dependencies
        run: pip install requests pytz

      - name: ğŸ“Š Fetch & Generate WakaTime Stats
        id: wakastats
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          python <<'EOF'
          import os, json, requests, pytz, base64
          from datetime import datetime, timedelta, timezone

          api_key = os.getenv("WAKATIME_API_KEY")
          if not api_key:
              raise Exception("WAKATIME_API_KEY is missing!")

          # Build explicit date ranges (WakaTime Summaries API requires start and end)
          today_utc = datetime.now(timezone.utc).date()
          start_7 = (today_utc - timedelta(days=6)).strftime('%Y-%m-%d')
          end_7 = today_utc.strftime('%Y-%m-%d')
          start_14 = (today_utc - timedelta(days=13)).strftime('%Y-%m-%d')
          end_14 = end_7

          # Fetch last 7 days (explicit start/end)
          url_last7 = f"https://wakatime.com/api/v1/users/current/summaries?start={start_7}&end={end_7}"
          # WakaTime requires base64-encoded API key for Basic auth
          encoded_key = base64.b64encode(api_key.encode()).decode()
          headers = {"Authorization": f"Basic {encoded_key}"}
          res_last7 = requests.get(url_last7, headers=headers)

          if res_last7.status_code != 200:
              raise Exception(f"Failed to fetch WakaTime data: {res_last7.text}")

          data_last7 = res_last7.json().get("data", [])
          if not data_last7:
              raise Exception("No data found in WakaTime response.")

          # Fetch last 14 days for comparison (explicit start/end)
          url_last14 = f"https://wakatime.com/api/v1/users/current/summaries?start={start_14}&end={end_14}"
          res_last14 = requests.get(url_last14, headers=headers)
          data_last14 = res_last14.json().get("data", []) if res_last14.status_code == 200 else []

          # --- Calculate Weekly Totals ---
          def calculate_total_seconds(data_list):
              total = 0
              for day in data_list:
                  total += day.get("grand_total", {}).get("total_seconds", 0)
              return total

          def format_time(seconds):
              if seconds == 0:
                  return "0 hrs 0 mins"
              hours = int(seconds // 3600)
              minutes = int((seconds % 3600) // 60)
              return f"{hours} hrs {minutes} mins"

          # This week (last 7 days)
          this_week_seconds = calculate_total_seconds(data_last7)
          this_week_formatted = format_time(this_week_seconds)

          # Last week (days 8-14 from the 14-day data)
          # The API returns days in chronological order, so we need days 1-7 for last week
          last_week_data = data_last14[:7] if len(data_last14) >= 14 else []
          last_week_seconds = calculate_total_seconds(last_week_data)
          last_week_formatted = format_time(last_week_seconds)

          # Calculate percentage change
          if last_week_seconds > 0:
              change_percent = ((this_week_seconds - last_week_seconds) / last_week_seconds) * 100
              change_indicator = "ğŸ“ˆ" if change_percent > 0 else "ğŸ“‰" if change_percent < 0 else "â¡ï¸"
              change_text = f"{change_indicator} {abs(change_percent):.1f}%"
          else:
              change_text = "ğŸ†• New"

          # --- Daily Breakdown for Chart ---
          daily_hours = []
          daily_labels = []
          for day in data_last7:
              date = day.get("range", {}).get("date", "")
              total_secs = day.get("grand_total", {}).get("total_seconds", 0)
              hours = round(total_secs / 3600, 2)
              daily_hours.append(hours)
              # Format date as Mon, Tue, etc.
              if date:
                  day_name = datetime.strptime(date, "%Y-%m-%d").strftime("%a")
                  daily_labels.append(day_name)
              else:
                  daily_labels.append("N/A")

          # --- Wake-up Coding Time ---
          today_summary = data_last7[-1] if data_last7 else {}
          first_activity = today_summary.get("range", {}).get("start", "")
          wakeup_time = "N/A"
          if first_activity:
              utc_dt = datetime.fromisoformat(first_activity.replace("Z", "+00:00"))
              wakeup_time = utc_dt.astimezone(pytz.timezone("Asia/Kolkata")).strftime("%H:%M:%S")

          # --- Most Productive Day ---
          if data_last7:
              most_productive_day = max(data_last7, key=lambda x: x.get("grand_total", {}).get("total_seconds", 0))
              most_productive_date = most_productive_day.get("range", {}).get("date", "")
              most_productive_hours = round(most_productive_day.get("grand_total", {}).get("total_seconds", 0) / 3600, 2)
              most_productive_day_name = datetime.strptime(most_productive_date, "%Y-%m-%d").strftime("%A") if most_productive_date else "N/A"
          else:
              most_productive_day_name = "N/A"
              most_productive_hours = 0

          # --- Languages & Editors Stats ---
          languages = {}
          editors = {}
          for day in data_last7:
              for lang in day.get("languages", []):
                  lang_name = lang.get("name", "Unknown")
                  lang_seconds = lang.get("total_seconds", 0)
                  languages[lang_name] = languages.get(lang_name, 0) + lang_seconds
              for editor in day.get("editors", []):
                  editor_name = editor.get("name", "Unknown")
                  editor_seconds = editor.get("total_seconds", 0)
                  editors[editor_name] = editors.get(editor_name, 0) + editor_seconds

          top_language = max(languages.items(), key=lambda x: x[1])[0] if languages else "N/A"
          top_editor = max(editors.items(), key=lambda x: x[1])[0] if editors else "N/A"

          # --- Today and Yesterday Stats ---
          today_data = data_last7[-1] if len(data_last7) >= 1 else {}
          yesterday_data = data_last7[-2] if len(data_last7) >= 2 else {}
          
          today_seconds = today_data.get("grand_total", {}).get("total_seconds", 0)
          yesterday_seconds = yesterday_data.get("grand_total", {}).get("total_seconds", 0)
          
          today_formatted = format_time(today_seconds)
          yesterday_formatted = format_time(yesterday_seconds)

          # --- Prepare Output Data ---
          output = {
              "generated_at_utc": datetime.now(timezone.utc).isoformat(),
              "wake_up_time": wakeup_time,
              "summary_days": len(data_last7),
              "latest_day": today_summary.get("range", {}).get("date", ""),
              "total_coding_time": today_summary.get("grand_total", {}).get("text", "0 mins"),
              "today_total": today_formatted,
              "yesterday_total": yesterday_formatted,
              "this_week_total": this_week_formatted,
              "last_week_total": last_week_formatted,
              "week_change": change_text,
              "daily_hours": daily_hours,
              "daily_labels": daily_labels,
              "most_productive_day": most_productive_day_name,
              "most_productive_hours": most_productive_hours,
              "top_language": top_language,
              "top_editor": top_editor,
              "raw_data": data_last7
          }

          # Save JSON for portfolio or future use
          with open("wakatime_stats.json", "w") as f:
              json.dump(output, f, indent=2)

          print(f"Today: {today_formatted}")
          print(f"Yesterday: {yesterday_formatted}")
          print(f"This Week: {this_week_formatted}")
          print(f"Last Week: {last_week_formatted}")
          print(f"Change: {change_text}")
          print(f"Most Productive: {most_productive_day_name} ({most_productive_hours} hrs)")
          EOF

      - name: ğŸ§  Update README with Dynamic Stats
        run: |
          python <<'PYEOF'
          import json
          import re
          from datetime import datetime, timezone

          # Read the stats
          with open("wakatime_stats.json", "r") as f:
              stats = json.load(f)

          # Read README
          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          # Update all dynamic fields
          updated = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
          today = stats.get("today_total", "0 hrs 0 mins")
          yesterday = stats.get("yesterday_total", "0 hrs 0 mins")
          this_week = stats.get("this_week_total", "0 hrs 0 mins")
          last_week = stats.get("last_week_total", "0 hrs 0 mins")
          change = stats.get("week_change", "N/A")
          productive_day = stats.get("most_productive_day", "N/A")
          productive_hours = stats.get("most_productive_hours", 0)
          top_lang = stats.get("top_language", "N/A")
          top_editor = stats.get("top_editor", "N/A")

          # Calculate additional metrics
          daily_hours = stats.get("daily_hours", [])
          active_days = sum(1 for h in daily_hours if h > 0)
          avg_daily = sum(daily_hours) / 7 if daily_hours else 0

          # Format for badges (replace spaces with underscores)
          today_badge = today.replace(" ", "_")
          yesterday_badge = yesterday.replace(" ", "_")
          this_week_badge = this_week.replace(" ", "_")
          last_week_badge = last_week.replace(" ", "_")
          change_badge = change.replace(" ", "_").replace("%", "%%25")

          # Format values for Quick Stats badges
          productive_badge = f"{productive_day}_({productive_hours:.1f}h)"
          top_lang_badge = top_lang.replace(" ", "_")
          top_editor_badge = top_editor.replace(" ", "_")
          avg_daily_badge = f"{avg_daily:.1f}_hrs"
          active_days_badge = f"{active_days}/7_days"

          # Helper function to safely replace between markers
          def safe_replace(content, start_marker, end_marker, new_value):
              try:
                  start = content.find(f"<!--{start_marker}-->")
                  end = content.find(f"<!--{end_marker}-->", start)
                  if start != -1 and end != -1:
                      old_content = content[start:end + len(f"<!--{end_marker}-->")]
                      new_content = f"<!--{start_marker}-->{new_value}<!--{end_marker}-->"
                      return content.replace(old_content, new_content, 1)
              except:
                  pass
              return content

          # Update timestamp
          readme = safe_replace(readme, "START_UPDATE_DATE", "END_UPDATE_DATE", updated)

          # Update Today stat badge in table
          readme = re.sub(
              r'!\[Today\]\(https://img\.shields\.io/badge/Today-[^)]+\)<!--START_TODAY_STAT--><!--END_TODAY_STAT-->',
              f'![Today](https://img.shields.io/badge/Today-{today_badge}-ff6b6b?style=for-the-badge&labelColor=1a1a2e)<!--START_TODAY_STAT--><!--END_TODAY_STAT-->',
              readme
          )

          # Update Yesterday stat badge
          readme = re.sub(
              r'!\[Yesterday\]\(https://img\.shields\.io/badge/Yesterday-[^)]+\)<!--START_YESTERDAY_STAT--><!--END_YESTERDAY_STAT-->',
              f'![Yesterday](https://img.shields.io/badge/Yesterday-{yesterday_badge}-feca57?style=for-the-badge&labelColor=1a1a2e)<!--START_YESTERDAY_STAT--><!--END_YESTERDAY_STAT-->',
              readme
          )

          # Update This Week stat badge
          readme = re.sub(
              r'!\[This Week\]\(https://img\.shields\.io/badge/This_Week-[^)]+\)<!--START_THISWEEK_STAT--><!--END_THISWEEK_STAT-->',
              f'![This Week](https://img.shields.io/badge/This_Week-{this_week_badge}-48dbfb?style=for-the-badge&labelColor=1a1a2e)<!--START_THISWEEK_STAT--><!--END_THISWEEK_STAT-->',
              readme
          )

          # Update Last Week stat badge
          readme = re.sub(
              r'!\[Last Week\]\(https://img\.shields\.io/badge/Last_Week-[^)]+\)<!--START_LASTWEEK_STAT--><!--END_LASTWEEK_STAT-->',
              f'![Last Week](https://img.shields.io/badge/Last_Week-{last_week_badge}-ff9ff3?style=for-the-badge&labelColor=1a1a2e)<!--START_LASTWEEK_STAT--><!--END_LASTWEEK_STAT-->',
              readme
          )

          # Update Quick Stats badges - full img tag replacement
          readme = re.sub(
              r'<img src="https://img\.shields\.io/badge/ğŸ†_Most_Productive-[^"]+style=for-the-badge&labelColor=1a1a2e" alt="Most Productive"/><!--START_PRODUCTIVE_DAY--><!--END_PRODUCTIVE_DAY-->',
              f'<img src="https://img.shields.io/badge/ğŸ†_Most_Productive-{productive_badge}-4CAF50?style=for-the-badge&labelColor=1a1a2e" alt="Most Productive"/><!--START_PRODUCTIVE_DAY--><!--END_PRODUCTIVE_DAY-->',
              readme
          )

          readme = re.sub(
              r'<img src="https://img\.shields\.io/badge/ğŸ’»_Top_Language-[^"]+style=for-the-badge&labelColor=1a1a2e" alt="Top Language"/><!--START_TOP_LANGUAGE--><!--END_TOP_LANGUAGE-->',
              f'<img src="https://img.shields.io/badge/ğŸ’»_Top_Language-{top_lang_badge}-2196F3?style=for-the-badge&labelColor=1a1a2e" alt="Top Language"/><!--START_TOP_LANGUAGE--><!--END_TOP_LANGUAGE-->',
              readme
          )

          readme = re.sub(
              r'<img src="https://img\.shields\.io/badge/ğŸ› ï¸_Editor-[^"]+style=for-the-badge&labelColor=1a1a2e" alt="Editor"/><!--START_TOP_EDITOR--><!--END_TOP_EDITOR-->',
              f'<img src="https://img.shields.io/badge/ğŸ› ï¸_Editor-{top_editor_badge}-FF9800?style=for-the-badge&labelColor=1a1a2e" alt="Editor"/><!--START_TOP_EDITOR--><!--END_TOP_EDITOR-->',
              readme
          )

          readme = re.sub(
              r'<img src="https://img\.shields\.io/badge/âš¡_Avg_Daily-[^"]+style=for-the-badge&labelColor=1a1a2e" alt="Avg Daily"/><!--START_AVG_DAILY--><!--END_AVG_DAILY-->',
              f'<img src="https://img.shields.io/badge/âš¡_Avg_Daily-{avg_daily_badge}-9C27B0?style=for-the-badge&labelColor=1a1a2e" alt="Avg Daily"/><!--START_AVG_DAILY--><!--END_AVG_DAILY-->',
              readme
          )

          readme = re.sub(
              r'<img src="https://img\.shields\.io/badge/ğŸ“…_Active_Days-[^"]+style=for-the-badge&labelColor=1a1a2e" alt="Active Days"/><!--START_ACTIVE_DAYS--><!--END_ACTIVE_DAYS-->',
              f'<img src="https://img.shields.io/badge/ğŸ“…_Active_Days-{active_days_badge}-00BCD4?style=for-the-badge&labelColor=1a1a2e" alt="Active Days"/><!--START_ACTIVE_DAYS--><!--END_ACTIVE_DAYS-->',
              readme
          )

          # Update Change badge
          readme = re.sub(
              r'!\[Change\]\(https://img\.shields\.io/badge/ğŸ“ˆ_Change-[^)]+\)<!--START_WEEK_CHANGE_BADGE--><!--END_WEEK_CHANGE_BADGE-->',
              f'![Change](https://img.shields.io/badge/ğŸ“ˆ_Change-{change_badge}-gray?style=for-the-badge&labelColor=1a1a2e)<!--START_WEEK_CHANGE_BADGE--><!--END_WEEK_CHANGE_BADGE-->',
              readme
          )

          # Write back
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(readme)

          print(f"âœ… README updated successfully!")
          print(f"ğŸ“… Today: {today}")
          print(f"ğŸ“† Yesterday: {yesterday}")
          print(f"ğŸ“Š This Week: {this_week}")
          print(f"ğŸ“† Last Week: {last_week}")
          print(f"ğŸ“ˆ Change: {change}")
          print(f"ğŸ† Most Productive: {productive_day} ({productive_hours:.1f}h)")
          print(f"âš¡ Avg Daily: {avg_daily:.1f} hrs")
          print(f"ğŸ“… Active Days: {active_days}/7")
          PYEOF
          
      - name: ğŸ’¾ Commit wakatime_stats.json
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-action-bot@users.noreply.github.com"
          git add wakatime_stats.json README.md
          git commit -m "ğŸ•’ Updated WakaTime JSON and README" || echo "No changes to commit"
          git push origin main
